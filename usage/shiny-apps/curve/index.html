<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>curve - TPO</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">TPO</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../../overview/" class="nav-link">Overview</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Setup</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../setup/summary/" class="dropdown-item">Summary</a>
</li>
                                    
<li>
    <a href="../../../setup/local-installation/" class="dropdown-item">Local Installation</a>
</li>
                                    
<li>
    <a href="../../../setup/local-build/" class="dropdown-item">Local Build</a>
</li>
                                    
<li>
    <a href="../../../setup/cloud-deployment/" class="dropdown-item">Cloud Deployment</a>
</li>
                                    
<li>
    <a href="../../../setup/local-development/" class="dropdown-item">Local Development</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Usage</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cli/" class="dropdown-item">TPO Command Line Interface</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Configuration</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../configuration/overview/" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="../../configuration/settings-file/" class="dropdown-item">Settings</a>
</li>
            
<li>
    <a href="../../configuration/genome-support/" class="dropdown-item">Genome-Support</a>
</li>
            
<li>
    <a href="../../configuration/bcl-barcodes/" class="dropdown-item">BCL-Barcodes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Tasks</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../tasks/overview/" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="../../tasks/analysis-tasks/" class="dropdown-item">Analysis Tasks</a>
</li>
            
<li>
    <a href="../../tasks/development-tasks/" class="dropdown-item">Development Tasks</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Pipelines</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../pipelines/overview/" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="../../pipelines/onco-seq/" class="dropdown-item">OncoSeq</a>
</li>
            
<li>
    <a href="../../pipelines/wgs-wes/" class="dropdown-item">WGS+WES</a>
</li>
            
<li>
    <a href="../../pipelines/shallow-wgs/" class="dropdown-item">Shallow WGS</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">R Packages</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../r-packages/overview/" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="../../r-packages/tpolib/" class="dropdown-item">tpolib</a>
</li>
            
<li>
    <a href="../../r-packages/codac/" class="dropdown-item">codac</a>
</li>
            
<li>
    <a href="../../r-packages/cnvex/" class="dropdown-item">cnvex</a>
</li>
            
<li>
    <a href="../../r-packages/carat/" class="dropdown-item">carat</a>
</li>
            
<li>
    <a href="../../r-packages/caniq/" class="dropdown-item">caniq</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Shiny Apps</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../overview/" class="dropdown-item">Overview</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">curve</a>
</li>
            
<li>
    <a href="../cnvex-viewer/" class="dropdown-item">cnvex-viewer</a>
</li>
            
<li>
    <a href="../structural-viewer.md" class="dropdown-item">structural-viewer</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Output</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../output/somatic-variants/" class="dropdown-item">Somatic Variants</a>
</li>
                                    
<li>
    <a href="../../../output/silos-and-vaults/" class="dropdown-item">Silos and Vaults</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../development/architecture/" class="dropdown-item">Architecture</a>
</li>
                                    
<li>
    <a href="../../../development/debugging/" class="dropdown-item">Debugging</a>
</li>
                                    
<li>
    <a href="../../../development/repository/" class="dropdown-item">Repository</a>
</li>
                                    
<li>
    <a href="../../../development/updating-references/" class="dropdown-item">Updating References</a>
</li>
                                    
<li>
    <a href="../../../development/updating-ensembl/" class="dropdown-item">Updating Ensembl</a>
</li>
                                    
<li>
    <a href="../../../development/updating-panel-of-normals/" class="dropdown-item">Updating Panel-of-Normals</a>
</li>
                                    
<li>
    <a href="../../../development/unit-testing/" class="dropdown-item">Unit Testing</a>
</li>
                                    
<li>
    <a href="../../../development/adding-tasks/" class="dropdown-item">Adding Tasks</a>
</li>
                                    
<li>
    <a href="../../../development/adding-capture-panel/" class="dropdown-item">Adding Capture Panel</a>
</li>
                                    
<li>
    <a href="../../../development/use-tpo-in-local-mode/" class="dropdown-item">Use TPO in Local Mode</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Notes</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../notes/overview/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../../notes/circos/" class="dropdown-item">circos</a>
</li>
                                    
<li>
    <a href="../../../notes/examples/" class="dropdown-item">Examples</a>
</li>
                                    
<li>
    <a href="../../../notes/misc/" class="dropdown-item">Misc</a>
</li>
                                    
<li>
    <a href="../../../notes/integrative-analysis/" class="dropdown-item">Integrative Analysis</a>
</li>
                                    
<li>
    <a href="../../../notes/use-cases/" class="dropdown-item">Use Cases</a>
</li>
                                    
<li>
    <a href="../../../notes/variant-and-feature-manual-review/" class="dropdown-item">Variant & Feature Manual Review</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../overview/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../cnvex-viewer/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#curve-portal" class="nav-link">CURVE Portal</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#initialization" class="nav-link">Initialization</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#adding-metadata" class="nav-link">Adding metadata</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#adding-feature-data" class="nav-link">Adding feature data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="curve-portal">CURVE Portal</h1>
<p>The <code>curve</code> R library included in TPO contains the code needed to create a case/patient-centered R Shiny portal for viewing TPO pipeline results. It enables users to deploy a Google Cloud instance with PostgeSQL and the appropriate schema, as well as the R Shiny application front end.  </p>
<h2 id="initialization">Initialization</h2>
<p>To launch a Google Cloud instance with the appropriate schema, first ensure that <code>CRISP_QUANT_GTF</code> is set to the correct gene model used during the analysis (regardless of whether <code>crisp-quant</code> or <code>crisp-quasr</code> was used for the RNA analysis). This GTF will be used to create the schema for the database to store gene expression data. Additionally, set <code>SECRETS_CURVE_USER</code> and <code>SECRETS_CURVE_PW</code> to a username and password of your choice. Next, run </p>
<pre><code>tpo.py -config &lt;my-config.ini&gt; curve_db_init &lt;name&gt;

</code></pre>
<p>When the task completes, a GCP instance with the <code>&lt;name&gt;</code> chosen above will be visible with </p>
<pre><code>gcloud compute instances list
</code></pre>
<p>Next, copy the internal IP of the new instance and use it to create the <code>CURVE_DB</code> environment variable like </p>
<pre><code>export CURVE_DB=&lt;ip address&gt;:5432:curvedb:&lt;SECRETS_CURVE_USER&gt;:&lt;SECRETS_CURVE_PW&gt;
</code></pre>
<p>Import a vault (the output of <code>carat_vault</code>) into the newly created database with </p>
<pre><code>Rscript &lt;TPO_ROOT&gt;/rlibs/curve/scripts/import_vault.R -v &lt;path to vault.rds&gt; -g &lt;path to gtf&gt;
</code></pre>
<p>After the desired vaults are imported, you must refresh some of the database views (this will happen automatically via <code>cron</code> <code>@daily</code>, but to proceed they must be updated once). </p>
<pre><code>&lt;TPO_ROOT&gt;/rlibs/curve/scripts/connect.sh
# run the following SQL commands
REFRESH MATERIALIZED VIEW somatic_recur;
REFRESH MATERIALIZED VIEW germline_recur;
REFRESH MATERIALIZED VIEW fusion_recur;
</code></pre>
<p>Finally, to run the application in R, first set the env variable (if it is not already set)</p>
<pre><code>devtools::load_all('/mnt/share/code/tpo/rlibs/curve')
Sys.setenv('CURVE_DB'='&lt;ip address&gt;:5432:curvedb:&lt;SECRETS_CURVE_USER&gt;:&lt;SECRETS_CURVE_PW&gt;')
shiny::runApp('./rlibs/curve/shiny')
</code></pre>
<p>To add additional databases to the existing GCP instance (e.g. for other projects), first set the <code>CURVE_DB</code> environment variable to the existing database, then modify the <code>mokefile.ini</code> with a new username and password (if desired), then run </p>
<pre><code>tpo.py -config &lt;my-config.ini&gt; curve_db_add &lt;new name&gt;

</code></pre>
<p>Then update your <code>CURVE_DB</code> environment variable to the new database credentials. </p>
<h2 id="adding-metadata">Adding metadata</h2>
<p>Metadata from a csv file can be added to the database and displayed in the sidebar. This metadata can either be per case (it will be applied to all analyses in the DB which match that case) or per tumor sample. The csv must have a column called <code>case</code> and optionally can have a column called <code>alignid_t</code>. If your <code>CURVE_DB</code> variable is set, run </p>
<pre><code>Rscript ./rlibs/curve/scripts/sideload_metadata.R -m ./curve_ready_metadata.csv
</code></pre>
<p>or you can provide a database if your choosing with </p>
<pre><code>Rscript ./rlibs/curve/scripts/sideload_metadata.R -m ./curve_ready_metadata.csv -d &quot;&lt;ip address&gt;:5432:curvedb:&lt;SECRETS_CURVE_USER&gt;:&lt;SECRETS_CURVE_PW&gt;&quot;
</code></pre>
<h2 id="adding-feature-data">Adding feature data</h2>
<p>Feature-level data (i.e. proteomics) can be added by running </p>
<pre><code>Rscript  ./rlibs/curve/scripts/sideload_featuredata.R -f tumor_proteomics_data.csv -g grch38.108.clean.gtf -n 'Tumor Proteomics'
</code></pre>
<p>The <code>-n|--name</code> argument specifies how it will be displayed in the database, this can have an unlimited number of values (i.e. "Tumor Proteomics", "Normal Proteomics" etc.)</p>
<p>The feature data should have a column called <code>gene_id</code> which maps to the gtf, and additional column names should be the tumor libraries in the <code>groupings.alignid_t</code> column in the database: </p>
<pre><code>gene_id,SI_31726,SI_31727,SI_31728,SI_31729,SI_31730,SI_31731
ENSG00000000003,25.658270426101506,25.177941588030407,26.259224491207846,25.08829842251876,25.35722453735322,24.19243418767442
ENSG00000000419,27.157933578782927,27.02590571202042,27.28431746818307,26.382172053762027,26.563799134992284,26.24792074908906
ENSG00000000457,22.107181257530307,22.377517486832268,22.786689254413982,22.247178863137258,22.519943787643896,22.711983638005982
ENSG00000000938,20.987427212477797,21.571249076966673,21.52211488625682,21.05133550391971,21.13084974148148,21.514292520849526
ENSG00000000971,29.78160643892207,29.22701562690786,29.530658892692795,29.835090234851148,30.87703665066274,30.37104840417782
ENSG00000001036,27.589627669217133,27.48563431228603,27.20853714345757,27.165062596101397,26.891624930214046,26.93188615596623
ENSG00000001084,27.564997110778258,27.621554193888702,27.385591592442797,27.116940514726977,27.752192110344744,27.97982524429814
ENSG00000001167,20.23906629527079,20.637911880139654,21.439503936347002,20.984022166587522,22.313036507648828,22.54092939525347
ENSG00000001461,NA,NA,NA,NA,NA,NA
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
